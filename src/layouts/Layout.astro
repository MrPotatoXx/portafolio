---
import Analytics from '@vercel/analytics/astro'
import SpeedInsights from "@vercel/speed-insights/astro"

import type { Messages } from "@/i18n";
import "../styles/global.css";
import LanguageSwitcher from "@/components/LanguageSwitcher.astro";

interface Props {
  title: string;
  description?: string;
  image?: string;
  canonical?: string;
  noindex?: boolean;
  lang?: string;
  t?: Messages;
  cv?: any;
}

const { title, description, image, canonical, noindex, lang = 'es', t, cv } = Astro.props as Props;
const defaultDescription = t?.site?.description ?? "Portafolio desarrollado en el framework Astro de Giovanni Salinas, Ingeniero en Informática.";

const toAbs = (pathOrUrl?: string, fallback = "/favicon.png") => {
  const candidate = pathOrUrl ?? fallback;
  try {
    if (!candidate) return fallback;
    if (candidate.startsWith("http")) return candidate;
    return Astro.site ? new URL(candidate, Astro.site).toString() : candidate;
  } catch {
    return candidate;
  }
};

const canonicalUrlStr = (() => {
  if (canonical) return canonical;
  try { return new URL(Astro.url.pathname, Astro.site).toString(); } catch { return "/"; }
})();

const seoDescription = description ?? defaultDescription;
const imageUrl = toAbs(image ?? "/favicon.png");
const robotsContent = noindex ? "noindex, nofollow" : "index, follow";
const currentLang = (t?.lang ?? lang ?? 'es');
const hreflang = (t?.locales?.hreflang ?? 'es');
const ogLocale = (t?.locales?.og ?? 'es_CL');

const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": cv?.basics?.name,
  "url": cv?.basics?.url,
  "image": cv?.basics?.image,
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  "sameAs": (cv?.basics?.profiles ?? []).map((p: any) => p.url),
  "jobTitle": cv?.basics?.label,
  "email": cv?.basics?.email ? `mailto:${cv?.basics?.email}` : undefined,
  "telephone": cv?.basics?.phone,
  "address": {
    "@type": "PostalAddress",
    "addressLocality": cv?.basics?.location?.city,
    "addressRegion": cv?.basics?.location?.region,
    "postalCode": cv?.basics?.location?.postalCode,
    "addressCountry": cv?.basics?.location?.countryCode
  }
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Portafolio de Giovanni Salinas",
  "url": cv?.basics?.url
};
---


<html lang={currentLang}>
	<head>
		<title>{title}</title>

		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="description" content={seoDescription} />
		<meta name="keywords" content="Giovanni Salinas, Ingeniería en Informática, Ciberseguridad, Desarrollo Web, Programación, Python, Ethical Hacker" />
		<meta name="author" content="Giovanni Salinas" />
		<meta http-equiv="content-language" content={hreflang} />
		<meta name="application-name" content={t?.site?.applicationName ?? "Portafolio de Giovanni Salinas"} />
		<meta name="theme-color" content="#0ea5e9" />

		<link rel="icon" type="image/png" href="/favicon.png" />
		<link rel="canonical" href={canonicalUrlStr} />
		<link rel="alternate" href={toAbs('/es/')} hreflang="es" />
		<link rel="alternate" href={toAbs('/en/')} hreflang="en" />
		<link rel="alternate" href={toAbs('/es/')} hreflang="x-default" />

		<meta name="robots" content={robotsContent} />
		<meta name="googlebot" content={robotsContent} />

		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={seoDescription} />
		<meta name="twitter:image" content={imageUrl} />

		<meta property="og:type" content="website" />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={seoDescription} />
		<meta property="og:image" content={imageUrl} />
		<meta property="og:url" content={canonicalUrlStr} />
		<meta property="og:site_name" content="Giovanni Salinas" />
		<meta property="og:locale" content={ogLocale} />

		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;700&display=swap"
			rel="stylesheet"
		/>

		<script type="application/ld+json" set:html={JSON.stringify(personSchema)}></script>
		<script type="application/ld+json" set:html={JSON.stringify(websiteSchema)}></script>
	</head>
	<body class="flex flex-col min-h-screen bg-dark-gradient-dots px-10">
		<LanguageSwitcher lang={currentLang === 'en' ? 'en' : 'es'} />
		<main class="flex-grow flex justify-center">
		  <slot />
		  <Analytics />
		  <SpeedInsights/>
		</main>
	  </body>
</html>
